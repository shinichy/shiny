/**
 * Copyright (c) 2009-2012 Jeremy Ashkenas
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */

define(["require","exports","module","./scope","./lexer","./helpers"],function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt={}.hasOwnProperty,dt=function(e,t){function r(){this.constructor=e}for(var n in t)pt.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},vt=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};R=e("./scope").Scope,ct=e("./lexer"),B=ct.RESERVED,q=ct.STRICT_PROSCRIBED,ht=e("./helpers"),Z=ht.compact,rt=ht.flatten,nt=ht.extend,st=ht.merge,et=ht.del,at=ht.starts,tt=ht.ends,it=ht.last,ut=ht.some,t.extend=nt,Y=function(){return!0},M=function(){return!1},V=function(){return this},O=function(){return this.negated=!this.negated,this},t.Base=o=function(){function e(){}return e.prototype.compile=function(e,t){var n;return e=nt({},e),t&&(e.level=t),n=this.unfoldSoak(e)||this,n.tab=e.indent,e.level===k||!n.isStatement(e)?n.compileNode(e):n.compileClosure(e)},e.prototype.compileClosure=function(e){if(this.jumps())throw SyntaxError("cannot use a pure statement in an expression.");return e.sharedScope=!0,l.wrap(this).compileNode(e)},e.prototype.cache=function(e,t,n){var r,i;return this.isComplex()?(r=new L(n||e.scope.freeVariable("ref")),i=new s(r,this),t?[i.compile(e,t),r.value]:[i,r]):(r=t?this.compile(e,t):this,[r,r])},e.prototype.compileLoopReference=function(e,t){var n,r;return n=r=this.compile(e,T),-Infinity<+n&&+n<Infinity||m.test(n)&&e.scope.check(n,!0)||(n=""+(r=e.scope.freeVariable(t))+" = "+n),[n,r]},e.prototype.makeReturn=function(e){var t;return t=this.unwrapAll(),e?new a(new L(""+e+".push"),[t]):new F(t)},e.prototype.contains=function(e){var t;return t=!1,this.traverseChildren(!1,function(n){if(e(n))return t=!0,!1}),t},e.prototype.containsType=function(e){return this instanceof e||this.contains(function(t){return t instanceof e})},e.prototype.lastNonComment=function(e){var t;t=e.length;while(t--)if(!(e[t]instanceof h))return e[t];return null},e.prototype.toString=function(e,t){var n;return e==null&&(e=""),t==null&&(t=this.constructor.name),n="\n"+e+t,this.soak&&(n+="?"),this.eachChild(function(t){return n+=t.toString(e+X)}),n},e.prototype.eachChild=function(e){var t,n,r,i,s,o,u,a;if(!this.children)return this;u=this.children;for(r=0,s=u.length;r<s;r++){t=u[r];if(this[t]){a=rt([this[t]]);for(i=0,o=a.length;i<o;i++){n=a[i];if(e(n)===!1)return this}}}return this},e.prototype.traverseChildren=function(e,t){return this.eachChild(function(n){return t(n)===!1?!1:n.traverseChildren(e,t)})},e.prototype.invert=function(){return new D("!",this)},e.prototype.unwrapAll=function(){var e;e=this;while(e!==(e=e.unwrap()))continue;return e},e.prototype.children=[],e.prototype.isStatement=M,e.prototype.jumps=M,e.prototype.isComplex=Y,e.prototype.isChainable=M,e.prototype.isAssignable=M,e.prototype.unwrap=V,e.prototype.unfoldSoak=M,e.prototype.assigns=M,e}(),t.Block=u=function(e){function t(e){this.expressions=Z(rt(e||[]))}return dt(t,e),t.prototype.children=["expressions"],t.prototype.push=function(e){return this.expressions.push(e),this},t.prototype.pop=function(){return this.expressions.pop()},t.prototype.unshift=function(e){return this.expressions.unshift(e),this},t.prototype.unwrap=function(){return this.expressions.length===1?this.expressions[0]:this},t.prototype.isEmpty=function(){return!this.expressions.length},t.prototype.isStatement=function(e){var t,n,r,i;i=this.expressions;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.isStatement(e))return!0}return!1},t.prototype.jumps=function(e){var t,n,r,i;i=this.expressions;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.jumps(e))return t}},t.prototype.makeReturn=function(e){var t,n;n=this.expressions.length;while(n--){t=this.expressions[n];if(!(t instanceof h)){this.expressions[n]=t.makeReturn(e),t instanceof F&&!t.expression&&this.expressions.splice(n,1);break}}return this},t.prototype.compile=function(e,n){return e==null&&(e={}),e.scope?t.__super__.compile.call(this,e,n):this.compileRoot(e)},t.prototype.compileNode=function(e){var n,r,i,s,o,u,a;this.tab=e.indent,s=e.level===k,r=[],a=this.expressions;for(o=0,u=a.length;o<u;o++)i=a[o],i=i.unwrapAll(),i=i.unfoldSoak(e)||i,i instanceof t?r.push(i.compileNode(e)):s?(i.front=!0,n=i.compile(e),i.isStatement(e)||(n=""+this.tab+n+";",i instanceof L&&(n=""+n+"\n")),r.push(n)):r.push(i.compile(e,T));return s?this.spaced?"\n"+r.join("\n\n")+"\n":r.join("\n"):(n=r.join(", ")||"void 0",r.length>1&&e.level>=T?"("+n+")":n)},t.prototype.compileRoot=function(e){var t,n,r,i,s,o;return e.indent=e.bare?"":X,e.scope=new R(null,this,null),e.level=k,this.spaced=!0,i="",e.bare||(s=function(){var e,t,i,s;i=this.expressions,s=[];for(r=e=0,t=i.length;e<t;r=++e){n=i[r];if(!(n.unwrap()instanceof h))break;s.push(n)}return s}.call(this),o=this.expressions.slice(s.length),this.expressions=s,s.length&&(i=""+this.compileNode(st(e,{indent:""}))+"\n"),this.expressions=o),t=this.compileWithDeclarations(e),e.bare?t:""+i+"(function() {\n"+t+"\n}).call(this);\n"},t.prototype.compileWithDeclarations=function(e){var t,n,r,i,s,o,u,a,f,l,c,p,d,v;n=o="",p=this.expressions;for(s=l=0,c=p.length;l<c;s=++l){i=p[s],i=i.unwrap();if(!(i instanceof h||i instanceof L))break}e=st(e,{level:k}),s&&(u=this.expressions.splice(s,9e9),d=[this.spaced,!1],f=d[0],this.spaced=d[1],v=[this.compileNode(e),f],n=v[0],this.spaced=v[1],this.expressions=u),o=this.compileNode(e),a=e.scope;if(a.expressions===this){r=e.scope.hasDeclarations(),t=a.hasAssignments;if(r||t)s&&(n+="\n"),n+=""+this.tab+"var ",r&&(n+=a.declaredVariables().join(", ")),t&&(r&&(n+=",\n"+(this.tab+X)),n+=a.assignedVariables().join(",\n"+(this.tab+X))),n+=";\n"}return n+o},t.wrap=function(e){return e.length===1&&e[0]instanceof t?e[0]:new t(e)},t}(o),t.Literal=L=function(e){function t(e){this.value=e}return dt(t,e),t.prototype.makeReturn=function(){return this.isStatement()?this:t.__super__.makeReturn.apply(this,arguments)},t.prototype.isAssignable=function(){return m.test(this.value)},t.prototype.isStatement=function(){var e;return(e=this.value)==="break"||e==="continue"||e==="debugger"},t.prototype.isComplex=M,t.prototype.assigns=function(e){return e===this.value},t.prototype.jumps=function(e){if(this.value==="break"&&!((e!=null?e.loop:void 0)||(e!=null?e.block:void 0)))return this;if(this.value==="continue"&&(e!=null?!e.loop:!void 0))return this},t.prototype.compileNode=function(e){var t,n;return t=this.value==="this"?((n=e.scope.method)!=null?n.bound:void 0)?e.scope.method.context:this.value:this.value.reserved?'"'+this.value+'"':this.value,this.isStatement()?""+this.tab+t+";":t},t.prototype.toString=function(){return' "'+this.value+'"'},t}(o),t.Undefined=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return dt(t,e),t.prototype.isAssignable=M,t.prototype.isComplex=M,t.prototype.compileNode=function(e){return e.level>=S?"(void 0)":"void 0"},t}(o),t.Null=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return dt(t,e),t.prototype.isAssignable=M,t.prototype.isComplex=M,t.prototype.compileNode=function(){return"null"},t}(o),t.Bool=function(e){function t(e){this.val=e}return dt(t,e),t.prototype.isAssignable=M,t.prototype.isComplex=M,t.prototype.compileNode=function(){return this.val},t}(o),t.Return=F=function(e){function t(e){e&&!e.unwrap().isUndefined&&(this.expression=e)}return dt(t,e),t.prototype.children=["expression"],t.prototype.isStatement=Y,t.prototype.makeReturn=V,t.prototype.jumps=V,t.prototype.compile=function(e,n){var r,i;return r=(i=this.expression)!=null?i.makeReturn():void 0,!r||r instanceof t?t.__super__.compile.call(this,e,n):r.compile(e,n)},t.prototype.compileNode=function(e){return this.tab+("return"+[this.expression?" "+this.expression.compile(e,C):void 0]+";")},t}(o),t.Value=Q=function(e){function t(e,n,r){return!n&&e instanceof t?e:(this.base=e,this.properties=n||[],r&&(this[r]=!0),this)}return dt(t,e),t.prototype.children=["base","properties"],t.prototype.add=function(e){return this.properties=this.properties.concat(e),this},t.prototype.hasProperties=function(){return!!this.properties.length},t.prototype.isArray=function(){return!this.properties.length&&this.base instanceof i},t.prototype.isComplex=function(){return this.hasProperties()||this.base.isComplex()},t.prototype.isAssignable=function(){return this.hasProperties()||this.base.isAssignable()},t.prototype.isSimpleNumber=function(){return this.base instanceof L&&I.test(this.base.value)},t.prototype.isString=function(){return this.base instanceof L&&y.test(this.base.value)},t.prototype.isAtomic=function(){var e,t,n,r;r=this.properties.concat(this.base);for(t=0,n=r.length;t<n;t++){e=r[t];if(e.soak||e instanceof a)return!1}return!0},t.prototype.isStatement=function(e){return!this.properties.length&&this.base.isStatement(e)},t.prototype.assigns=function(e){return!this.properties.length&&this.base.assigns(e)},t.prototype.jumps=function(e){return!this.properties.length&&this.base.jumps(e)},t.prototype.isObject=function(e){return this.properties.length?!1:this.base instanceof _&&(!e||this.base.generated)},t.prototype.isSplice=function(){return it(this.properties)instanceof U},t.prototype.unwrap=function(){return this.properties.length?this:this.base},t.prototype.cacheReference=function(e){var n,r,i,o;return i=it(this.properties),this.properties.length<2&&!this.base.isComplex()&&(i!=null?!i.isComplex():!void 0)?[this,this]:(n=new t(this.base,this.properties.slice(0,-1)),n.isComplex()&&(r=new L(e.scope.freeVariable("base")),n=new t(new H(new s(r,n)))),i?(i.isComplex()&&(o=new L(e.scope.freeVariable("name")),i=new E(new s(o,i.index)),o=new E(o)),[n.add(i),new t(r||n.base,[o||i])]):[n,r])},t.prototype.compileNode=function(e){var t,n,r,i,s;this.base.front=this.front,r=this.properties,t=this.base.compile(e,r.length?S:null),(this.base instanceof H||r.length)&&I.test(t)&&(t=""+t+".");for(i=0,s=r.length;i<s;i++)n=r[i],t+=n.compile(e);return t},t.prototype.unfoldSoak=function(e){var n,r=this;return this.unfoldedSoak!=null?this.unfoldedSoak:(n=function(){var n,i,o,u,a,f,l,c,h;if(o=r.base.unfoldSoak(e))return Array.prototype.push.apply(o.body.properties,r.properties),o;h=r.properties;for(i=l=0,c=h.length;l<c;i=++l){u=h[i];if(!u.soak)continue;return u.soak=!1,n=new t(r.base,r.properties.slice(0,i)),f=new t(r.base,r.properties.slice(i)),n.isComplex()&&(a=new L(e.scope.freeVariable("ref")),n=new H(new s(a,n)),f.base=a),new b(new p(n),f,{soak:!0})}return null}(),this.unfoldedSoak=n||!1)},t}(o),t.Comment=h=function(e){function t(e){this.comment=e}return dt(t,e),t.prototype.isStatement=Y,t.prototype.makeReturn=V,t.prototype.compileNode=function(e,t){var n;return n="/*"+ot(this.comment,this.tab)+("\n"+this.tab+"*/\n"),(t||e.level)===k&&(n=e.indent+n),n},t}(o),t.Call=a=function(e){function t(e,t,n){this.args=t!=null?t:[],this.soak=n,this.isNew=!1,this.isSuper=e==="super",this.variable=this.isSuper?null:e}return dt(t,e),t.prototype.children=["variable","args"],t.prototype.newInstance=function(){var e,n;return e=((n=this.variable)!=null?n.base:void 0)||this.variable,e instanceof t&&!e.isNew?e.newInstance():this.isNew=!0,this},t.prototype.superReference=function(e){var t,n,i;n=e.scope.namedMethod();if(!n)throw SyntaxError("cannot call super outside of a function.");i=n.name;if(i==null)throw SyntaxError("cannot call super on an anonymous function.");return n.klass?(t=[new r(new L("__super__"))],n["static"]&&t.push(new r(new L("constructor"))),t.push(new r(new L(i))),(new Q(new L(n.klass),t)).compile(e)):""+i+".__super__.constructor"},t.prototype.superThis=function(e){var t;return t=e.scope.method,t&&!t.klass&&t.context||"this"},t.prototype.unfoldSoak=function(e){var n,r,i,s,o,u,a,f,l;if(this.soak){if(this.variable){if(r=ft(e,this,"variable"))return r;f=(new Q(this.variable)).cacheReference(e),i=f[0],o=f[1]}else i=new L(this.superReference(e)),o=new Q(i);return o=new t(o,this.args),o.isNew=this.isNew,i=new L("typeof "+i.compile(e)+' === "function"'),new b(i,new Q(o),{soak:!0})}n=this,s=[];for(;;){if(n.variable instanceof t){s.push(n),n=n.variable;continue}if(!(n.variable instanceof Q))break;s.push(n);if(!((n=n.variable.base)instanceof t))break}l=s.reverse();for(u=0,a=l.length;u<a;u++)n=l[u],r&&(n.variable instanceof t?n.variable=r:n.variable.base=r),r=ft(e,n,"variable");return r},t.prototype.filterImplicitObjects=function(e){var t,n,r,i,o,u,a,f,l,c;n=[];for(u=0,f=e.length;u<f;u++){t=e[u];if(!((typeof t.isObject=="function"?t.isObject():void 0)&&t.base.generated)){n.push(t);continue}r=null,c=t.base.properties;for(a=0,l=c.length;a<l;a++)i=c[a],i instanceof s||i instanceof h?(r||n.push(r=new _(o=[],!0)),o.push(i)):(n.push(i),r=null)}return n},t.prototype.compileNode=function(e){var t,n,r,i;return(i=this.variable)!=null&&(i.front=this.front),(r=z.compileSplattedArray(e,this.args,!0))?this.compileSplat(e,r):(n=this.filterImplicitObjects(this.args),n=function(){var r,i,s;s=[];for(r=0,i=n.length;r<i;r++)t=n[r],s.push(t.compile(e,T));return s}().join(", "),this.isSuper?this.superReference(e)+(".call("+this.superThis(e)+(n&&", "+n)+")"):(this.isNew?"new ":"")+this.variable.compile(e,S)+("("+n+")"))},t.prototype.compileSuper=function(e,t){return""+this.superReference(t)+".call("+this.superThis(t)+(e.length?", ":"")+e+")"},t.prototype.compileSplat=function(e,t){var n,r,i,s,o;return this.isSuper?""+this.superReference(e)+".apply("+this.superThis(e)+", "+t+")":this.isNew?(i=this.tab+X,"(function(func, args, ctor) {\n"+i+"ctor.prototype = func.prototype;\n"+i+"var child = new ctor, result = func.apply(child, args), t = typeof result;\n"+i+'return t == "object" || t == "function" ? result || child : child;\n'+this.tab+"})("+this.variable.compile(e,T)+", "+t+", function(){})"):(n=new Q(this.variable),(s=n.properties.pop())&&n.isComplex()?(o=e.scope.freeVariable("ref"),r="("+o+" = "+n.compile(e,T)+")"+s.compile(e)):(r=n.compile(e,S),I.test(r)&&(r="("+r+")"),s?(o=r,r+=s.compile(e)):o="null"),""+r+".apply("+o+", "+t+")")},t}(o),t.Extends=d=function(e){function t(e,t){this.child=e,this.parent=t}return dt(t,e),t.prototype.children=["child","parent"],t.prototype.compile=function(e){return(new a(new Q(new L(lt("extends"))),[this.child,this.parent])).compile(e)},t}(o),t.Access=r=function(e){function t(e,t){this.name=e,this.name.asKey=!0,this.soak=t==="soak"}return dt(t,e),t.prototype.children=["name"],t.prototype.compile=function(e){var t;return t=this.name.compile(e),m.test(t)?"."+t:"["+t+"]"},t.prototype.isComplex=M,t}(o),t.Index=E=function(e){function t(e){this.index=e}return dt(t,e),t.prototype.children=["index"],t.prototype.compile=function(e){return"["+this.index.compile(e,C)+"]"},t.prototype.isComplex=function(){return this.index.isComplex()},t}(o),t.Range=j=function(e){function t(e,t,n){this.from=e,this.to=t,this.exclusive=n==="exclusive",this.equals=this.exclusive?"":"="}return dt(t,e),t.prototype.children=["from","to"],t.prototype.compileVariables=function(e){var t,n,r,i,s;e=st(e,{top:!0}),n=this.from.cache(e,T),this.fromC=n[0],this.fromVar=n[1],r=this.to.cache(e,T),this.toC=r[0],this.toVar=r[1];if(t=et(e,"step"))i=t.cache(e,T),this.step=i[0],this.stepVar=i[1];s=[this.fromVar.match(I),this.toVar.match(I)],this.fromNum=s[0],this.toNum=s[1];if(this.stepVar)return this.stepNum=this.stepVar.match(I)},t.prototype.compileNode=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;return this.fromVar||this.compileVariables(e),e.index?(u=this.fromNum&&this.toNum,s=et(e,"index"),o=et(e,"name"),f=o&&o!==s,h=""+s+" = "+this.fromC,this.toC!==this.toVar&&(h+=", "+this.toC),this.step!==this.stepVar&&(h+=", "+this.step),p=[""+s+" <"+this.equals,""+s+" >"+this.equals],a=p[0],i=p[1],n=this.stepNum?+this.stepNum>0?""+a+" "+this.toVar:""+i+" "+this.toVar:u?(d=[+this.fromNum,+this.toNum],r=d[0],c=d[1],d,r<=c?""+a+" "+c:""+i+" "+c):(t=""+this.fromVar+" <= "+this.toVar,""+t+" ? "+a+" "+this.toVar+" : "+i+" "+this.toVar),l=this.stepVar?""+s+" += "+this.stepVar:u?f?r<=c?"++"+s:"--"+s:r<=c?""+s+"++":""+s+"--":f?""+t+" ? ++"+s+" : --"+s:""+t+" ? "+s+"++ : "+s+"--",f&&(h=""+o+" = "+h),f&&(l=""+o+" = "+l),""+h+"; "+n+"; "+l):this.compileArray(e)},t.prototype.compileArray=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;if(this.fromNum&&this.toNum&&Math.abs(this.fromNum-this.toNum)<=20)return f=function(){v=[];for(var e=p=+this.fromNum,t=+this.toNum;p<=t?e<=t:e>=t;p<=t?e++:e--)v.push(e);return v}.apply(this),this.exclusive&&f.pop(),"["+f.join(", ")+"]";o=this.tab+X,s=e.scope.freeVariable("i"),l=e.scope.freeVariable("results"),a="\n"+o+l+" = [];",this.fromNum&&this.toNum?(e.index=s,n=this.compileNode(e)):(c=""+s+" = "+this.fromC+(this.toC!==this.toVar?", "+this.toC:""),r=""+this.fromVar+" <= "+this.toVar,n="var "+c+"; "+r+" ? "+s+" <"+this.equals+" "+this.toVar+" : "+s+" >"+this.equals+" "+this.toVar+"; "+r+" ? "+s+"++ : "+s+"--"),u="{ "+l+".push("+s+"); }\n"+o+"return "+l+";\n"+e.indent,i=function(e){return e!=null?e.contains(function(e){return e instanceof L&&e.value==="arguments"&&!e.asKey}):void 0};if(i(this.from)||i(this.to))t=", arguments";return"(function() {"+a+"\n"+o+"for ("+n+")"+u+"}).apply(this"+(t!=null?t:"")+")"},t}(o),t.Slice=U=function(e){function t(e){this.range=e,t.__super__.constructor.call(this)}return dt(t,e),t.prototype.children=["range"],t.prototype.compileNode=function(e){var t,n,r,i,s,o;return o=this.range,i=o.to,n=o.from,r=n&&n.compile(e,C)||"0",t=i&&i.compile(e,C),i&&(!!this.range.exclusive||+t!==-1)&&(s=", "+(this.range.exclusive?t:I.test(t)?""+(+t+1):(t=i.compile(e,S),"+"+t+" + 1 || 9e9"))),".slice("+r+(s||"")+")"},t}(o),t.Obj=_=function(e){function t(e,t){this.generated=t!=null?t:!1,this.objects=this.properties=e||[]}return dt(t,e),t.prototype.children=["properties"],t.prototype.compileNode=function(e){var t,n,r,i,o,u,a,f,l,c,p;l=this.properties;if(!l.length)return this.front?"({})":"{}";if(this.generated)for(c=0,p=l.length;c<p;c++){u=l[c];if(u instanceof Q)throw new Error("cannot have an implicit value in an implicit object")}return n=e.indent+=X,o=this.lastNonComment(this.properties),l=function(){var u,a,c;c=[];for(t=u=0,a=l.length;u<a;t=++u)f=l[t],i=t===l.length-1?"":f===o||f instanceof h?"\n":",\n",r=f instanceof h?"":n,f instanceof Q&&f["this"]&&(f=new s(f.properties[0].name,f,"object")),f instanceof h||(f instanceof s||(f=new s(f,f,"object")),(f.variable.base||f.variable).asKey=!0),c.push(r+f.compile(e,k)+i);return c}(),l=l.join(""),a="{"+(l&&"\n"+l+"\n"+this.tab)+"}",this.front?"("+a+")":a},t.prototype.assigns=function(e){var t,n,r,i;i=this.properties;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.assigns(e))return!0}return!1},t}(o),t.Arr=i=function(e){function t(e){this.objects=e||[]}return dt(t,e),t.prototype.children=["objects"],t.prototype.filterImplicitObjects=a.prototype.filterImplicitObjects,t.prototype.compileNode=function(e){var t,n,r;return this.objects.length?(e.indent+=X,r=this.filterImplicitObjects(this.objects),(t=z.compileSplattedArray(e,r))?t:(t=function(){var t,i,s;s=[];for(t=0,i=r.length;t<i;t++)n=r[t],s.push(n.compile(e,T));return s}().join(", "),t.indexOf("\n")>=0?"[\n"+e.indent+t+"\n"+this.tab+"]":"["+t+"]")):"[]"},t.prototype.assigns=function(e){var t,n,r,i;i=this.objects;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.assigns(e))return!0}return!1},t}(o),t.Class=f=function(e){function t(e,t,n){this.variable=e,this.parent=t,this.body=n!=null?n:new u,this.boundFuncs=[],this.body.classBody=!0}return dt(t,e),t.prototype.children=["variable","parent","body"],t.prototype.determineName=function(){var e,t;if(!this.variable)return null;e=(t=it(this.variable.properties))?t instanceof r&&t.name.value:this.variable.base.value;if(vt.call(q,e)>=0)throw SyntaxError("variable name may not be "+e);return e&&(e=m.test(e)&&e)},t.prototype.setContext=function(e){return this.body.traverseChildren(!1,function(t){if(t.classBody)return!1;if(t instanceof L&&t.value==="this")return t.value=e;if(t instanceof c){t.klass=e;if(t.bound)return t.context=e}})},t.prototype.addBoundFunctions=function(e){var t,n,i,s,o,u;if(this.boundFuncs.length){o=this.boundFuncs,u=[];for(i=0,s=o.length;i<s;i++)t=o[i],n=(new Q(new L("this"),[new r(t)])).compile(e),u.push(this.ctor.body.unshift(new L(""+n+" = "+lt("bind")+"("+n+", this)")));return u}},t.prototype.addProperties=function(e,t,n){var i,o,u,a,f;return f=e.base.properties.slice(0),u=function(){var e;e=[];while(i=f.shift()){if(i instanceof s){o=i.variable.base,delete i.context,a=i.value;if(o.value==="constructor"){if(this.ctor)throw new Error("cannot define more than one constructor in a class");if(a.bound)throw new Error("cannot define a constructor as a bound function");a instanceof c?i=this.ctor=a:(this.externalCtor=n.scope.freeVariable("class"),i=new s(new L(this.externalCtor),a))}else i.variable["this"]?(a["static"]=!0,a.bound&&(a.context=t)):(i.variable=new Q(new L(t),[new r(new L("prototype")),new r(o)]),a instanceof c&&a.bound&&(this.boundFuncs.push(o),a.bound=!1))}e.push(i)}return e}.call(this),Z(u)},t.prototype.walkBody=function(e,n){var r=this;return this.traverseChildren(!1,function(i){var s,o,a,f,l,c;if(i instanceof t)return!1;if(i instanceof u){c=s=i.expressions;for(o=f=0,l=c.length;f<l;o=++f)a=c[o],a instanceof Q&&a.isObject(!0)&&(s[o]=r.addProperties(a,e,n));return i.expressions=s=rt(s)}})},t.prototype.hoistDirectivePrologue=function(){var e,t,n;t=0,e=this.body.expressions;while((n=e[t])&&n instanceof h||n instanceof Q&&n.isString())++t;return this.directives=e.splice(0,t)},t.prototype.ensureConstructor=function(e){return this.ctor||(this.ctor=new c,this.parent&&this.ctor.body.push(new L(""+e+".__super__.constructor.apply(this, arguments)")),this.externalCtor&&this.ctor.body.push(new L(""+this.externalCtor+".apply(this, arguments)")),this.ctor.body.makeReturn(),this.body.expressions.unshift(this.ctor)),this.ctor.ctor=this.ctor.name=e,this.ctor.klass=null,this.ctor.noReturn=!0},t.prototype.compileNode=function(e){var t,n,r,i,o,u,a;return n=this.determineName(),o=n||"_Class",o.reserved&&(o="_"+o),i=new L(o),this.hoistDirectivePrologue(),this.setContext(o),this.walkBody(o,e),this.ensureConstructor(o),this.body.spaced=!0,this.ctor instanceof c||this.body.expressions.unshift(this.ctor),this.body.expressions.push(i),(a=this.body.expressions).unshift.apply(a,this.directives),this.addBoundFunctions(e),t=l.wrap(this.body),this.parent&&(this.superClass=new L(e.scope.freeVariable("super",!1)),this.body.expressions.unshift(new d(i,this.superClass)),t.args.push(this.parent),u=t.variable.params||t.variable.base.params,u.push(new P(this.superClass))),r=new H(t,!0),this.variable&&(r=new s(this.variable,r)),r.compile(e)},t}(o),t.Assign=s=function(e){function t(e,t,n,r){var i,s,o;this.variable=e,this.value=t,this.context=n,this.param=r&&r.param,this.subpattern=r&&r.subpattern,i=(o=s=this.variable.unwrapAll().value,vt.call(q,o)>=0);if(i&&this.context!=="object")throw SyntaxError('variable name may not be "'+s+'"')}return dt(t,e),t.prototype.children=["variable","value"],t.prototype.isStatement=function(e){return(e!=null?e.level:void 0)===k&&this.context!=null&&vt.call(this.context,"?")>=0},t.prototype.assigns=function(e){return this[this.context==="object"?"value":"variable"].assigns(e)},t.prototype.unfoldSoak=function(e){return ft(e,this,"variable")},t.prototype.compileNode=function(e){var t,n,r,i,s,o,u,a,f;if(t=this.variable instanceof Q){if(this.variable.isArray()||this.variable.isObject())return this.compilePatternMatch(e);if(this.variable.isSplice())return this.compileSplice(e);if((o=this.context)==="||="||o==="&&="||o==="?=")return this.compileConditional(e)}r=this.variable.compile(e,T);if(!this.context){if(!(s=this.variable.unwrapAll()).isAssignable())throw SyntaxError('"'+this.variable.compile(e)+'" cannot be assigned.');if(typeof s.hasProperties=="function"?!s.hasProperties():!void 0)this.param?e.scope.add(r,"var"):e.scope.find(r)}return this.value instanceof c&&(n=A.exec(r))&&(n[1]&&(this.value.klass=n[1]),this.value.name=(u=(a=(f=n[2])!=null?f:n[3])!=null?a:n[4])!=null?u:n[5]),i=this.value.compile(e,T),this.context==="object"?""+r+": "+i:(i=r+(" "+(this.context||"=")+" ")+i,e.level<=T?i:"("+i+")")},t.prototype.compilePatternMatch=function(e){var n,i,s,o,u,a,f,l,c,h,p,d,v,g,y,b,w,S,x,C,A,O,M,_,D,P,j;y=e.level===k,w=this.value,h=this.variable.base.objects;if(!(p=h.length))return s=w.compile(e),e.level>=N?"("+s+")":s;a=this.variable.isObject();if(y&&p===1&&!((c=h[0])instanceof z)){c instanceof t?(A=c,O=A.variable,u=O.base,c=A.value):c.base instanceof H?(M=(new Q(c.unwrapAll())).cacheReference(e),c=M[0],u=M[1]):u=a?c["this"]?c.properties[0].name:c:new L(0),n=m.test(u.unwrap().value||0),w=new Q(w),w.properties.push(new(n?r:E)(u));if(_=c.unwrap().value,vt.call(B,_)>=0)throw new SyntaxError("assignment to a reserved word: "+c.compile(e)+" = "+w.compile(e));return(new t(c,w,null,{param:this.param})).compile(e,k)}S=w.compile(e,T),i=[],g=!1;if(!m.test(S)||this.variable.assigns(S))i.push(""+(d=e.scope.freeVariable("ref"))+" = "+S),S=d;for(o=x=0,C=h.length;x<C;o=++x){c=h[o],u=o,a&&(c instanceof t?(D=c,P=D.variable,u=P.base,c=D.value):c.base instanceof H?(j=(new Q(c.unwrapAll())).cacheReference(e),c=j[0],u=j[1]):u=c["this"]?c.properties[0].name:c);if(!g&&c instanceof z)l=c.name.unwrap().value,c=c.unwrap(),b=""+p+" <= "+S+".length ? "+lt("slice")+".call("+S+", "+o,(v=p-o-1)?(f=e.scope.freeVariable("i"),b+=", "+f+" = "+S+".length - "+v+") : ("+f+" = "+o+", [])"):b+=") : []",b=new L(b),g=""+f+"++";else{l=c.unwrap().value;if(c instanceof z)throw c=c.name.compile(e),new SyntaxError("multiple splats are disallowed in an assignment: "+c+"...");typeof u=="number"?(u=new L(g||u),n=!1):n=a&&m.test(u.unwrap().value||0),b=new Q(new L(S),[new(n?r:E)(u)])}if(l!=null&&vt.call(B,l)>=0)throw new SyntaxError("assignment to a reserved word: "+c.compile(e)+" = "+b.compile(e));i.push((new t(c,b,null,{param:this.param,subpattern:!0})).compile(e,T))}return!y&&!this.subpattern&&i.push(S),s=i.join(", "),e.level<T?s:"("+s+")"},t.prototype.compileConditional=function(e){var n,r,i;i=this.variable.cacheReference(e),n=i[0],r=i[1];if(!n.properties.length&&n.base instanceof L&&n.base.value!=="this"&&!e.scope.check(n.base.value))throw new Error('the variable "'+n.base.value+"\" can't be assigned with "+this.context+" because it has not been defined.");return vt.call(this.context,"?")>=0&&(e.isExistentialEquals=!0),(new D(this.context.slice(0,-1),n,new t(r,this.value,"="))).compile(e)},t.prototype.compileSplice=function(e){var t,n,r,i,s,o,u,a,f,l,c,h;return l=this.variable.properties.pop().range,r=l.from,u=l.to,n=l.exclusive,o=this.variable.compile(e),c=(r!=null?r.cache(e,N):void 0)||["0","0"],i=c[0],s=c[1],u?(r!=null?r.isSimpleNumber():void 0)&&u.isSimpleNumber()?(u=+u.compile(e)- +s,n||(u+=1)):(u=u.compile(e,S)+" - "+s,n||(u+=" + 1")):u="9e9",h=this.value.cache(e,T),a=h[0],f=h[1],t="[].splice.apply("+o+", ["+i+", "+u+"].concat("+a+")), "+f,e.level>k?"("+t+")":t},t}(o),t.Code=c=function(e){function t(e,t,n){this.params=e||[],this.body=t||new u,this.bound=n==="boundfunc",this.bound&&(this.context="_this")}return dt(t,e),t.prototype.children=["params","body"],t.prototype.isStatement=function(){return!!this.ctor},t.prototype.jumps=M,t.prototype.compileNode=function(e){var t,n,r,o,u,a,f,l,c,h,p,d,v,m,g,y,w,E,x,T,N,C,k,A,O,M,_,P,H,B,j,F,I;e.scope=new R(e.scope,this.body,this),e.scope.shared=et(e,"sharedScope"),e.indent+=X,delete e.bare,delete e.isExistentialEquals,c=[],n=[],_=this.paramNames();for(g=0,x=_.length;g<x;g++)a=_[g],e.scope.check(a)||e.scope.parameter(a);P=this.params;for(y=0,T=P.length;y<T;y++){l=P[y];if(!l.splat)continue;H=this.params;for(w=0,N=H.length;w<N;w++)f=H[w].name,f["this"]&&(f=f.properties[0].name),f.value&&e.scope.add(f.value,"var",!0);p=new s(new Q(new i(function(){var t,n,r,i;r=this.params,i=[];for(t=0,n=r.length;t<n;t++)f=r[t],i.push(f.asReference(e));return i}.call(this))),new Q(new L("arguments")));break}B=this.params;for(E=0,C=B.length;E<C;E++)l=B[E],l.isComplex()?(v=h=l.asReference(e),l.value&&(v=new D("?",h,l.value)),n.push(new s(new Q(l.name),v,"=",{param:!0}))):(h=l,l.value&&(u=new L(h.name.value+" == null"),v=new s(new Q(l.name),l.value,"="),n.push(new b(u,v)))),p||c.push(h);m=this.body.isEmpty(),p&&n.unshift(p),n.length&&(j=this.body.expressions).unshift.apply(j,n);for(r=O=0,k=c.length;O<k;r=++O)f=c[r],e.scope.parameter(c[r]=f.compile(e));d=[],F=this.paramNames();for(M=0,A=F.length;M<A;M++){a=F[M];if(vt.call(d,a)>=0)throw SyntaxError("multiple parameters named '"+a+"'");d.push(a)}return!m&&!this.noReturn&&this.body.makeReturn(),this.bound&&(((I=e.scope.parent.method)!=null?I.bound:void 0)?this.bound=this.context=e.scope.parent.method.context:this["static"]||e.scope.parent.assign("_this","this")),o=e.indent,t="function",this.ctor&&(t+=" "+this.name),t+="("+c.join(", ")+") {",this.body.isEmpty()||(t+="\n"+this.body.compileWithDeclarations(e)+"\n"+this.tab),t+="}",this.ctor?this.tab+t:this.front||e.level>=S?"("+t+")":t},t.prototype.paramNames=function(){var e,t,n,r,i;e=[],i=this.params;for(n=0,r=i.length;n<r;n++)t=i[n],e.push.apply(e,t.names());return e},t.prototype.traverseChildren=function(e,n){if(e)return t.__super__.traverseChildren.call(this,e,n)},t}(o),t.Param=P=function(e){function t(e,t,n){var r;this.name=e,this.value=t,this.splat=n;if(r=e=this.name.unwrapAll().value,vt.call(q,r)>=0)throw SyntaxError('parameter name "'+e+'" is not allowed')}return dt(t,e),t.prototype.children=["name","value"],t.prototype.compile=function(e){return this.name.compile(e,T)},t.prototype.asReference=function(e){var t;return this.reference?this.reference:(t=this.name,t["this"]?(t=t.properties[0].name,t.value.reserved&&(t=new L(e.scope.freeVariable(t.value)))):t.isComplex()&&(t=new L(e.scope.freeVariable("arg"))),t=new Q(t),this.splat&&(t=new z(t)),this.reference=t)},t.prototype.isComplex=function(){return this.name.isComplex()},t.prototype.names=function(e){var t,n,r,i,o,u;e==null&&(e=this.name),t=function(e){var t;return t=e.properties[0].name.value,t.reserved?[]:[t]};if(e instanceof L)return[e.value];if(e instanceof Q)return t(e);n=[],u=e.objects;for(i=0,o=u.length;i<o;i++){r=u[i];if(r instanceof s)n.push(r.value.unwrap().value);else if(r instanceof z)n.push(r.name.unwrap().value);else{if(!(r instanceof Q))throw SyntaxError("illegal parameter "+r.compile());r.isArray()||r.isObject()?n.push.apply(n,this.names(r.base)):r["this"]?n.push.apply(n,t(r)):n.push(r.base.value)}}return n},t}(o),t.Splat=z=function(e){function t(e){this.name=e.compile?e:new L(e)}return dt(t,e),t.prototype.children=["name"],t.prototype.isAssignable=Y,t.prototype.assigns=function(e){return this.name.assigns(e)},t.prototype.compile=function(e){return this.index!=null?this.compileParam(e):this.name.compile(e)},t.prototype.unwrap=function(){return this.name},t.compileSplattedArray=function(e,n,r){var i,s,o,u,a,f,l,c;a=-1;while((f=n[++a])&&!(f instanceof t))continue;if(a>=n.length)return"";if(n.length===1)return o=n[0].compile(e,T),r?o:""+lt("slice")+".call("+o+")";i=n.slice(a);for(u=l=0,c=i.length;l<c;u=++l)f=i[u],o=f.compile(e,T),i[u]=f instanceof t?""+lt("slice")+".call("+o+")":"["+o+"]";return a===0?i[0]+(".concat("+i.slice(1).join(", ")+")"):(s=function(){var t,r,i,s;i=n.slice(0,a),s=[];for(t=0,r=i.length;t<r;t++)f=i[t],s.push(f.compile(e,T));return s}(),"["+s.join(", ")+"].concat("+i.join(", ")+")")},t}(o),t.While=G=function(e){function t(e,t){this.condition=(t!=null?t.invert:void 0)?e.invert():e,this.guard=t!=null?t.guard:void 0}return dt(t,e),t.prototype.children=["condition","guard","body"],t.prototype.isStatement=Y,t.prototype.makeReturn=function(e){return e?t.__super__.makeReturn.apply(this,arguments):(this.returns=!this.jumps({loop:!0}),this)},t.prototype.addBody=function(e){return this.body=e,this},t.prototype.jumps=function(){var e,t,n,r;e=this.body.expressions;if(!e.length)return!1;for(n=0,r=e.length;n<r;n++){t=e[n];if(t.jumps({loop:!0}))return t}return!1},t.prototype.compileNode=function(e){var t,n,r,i;return e.indent+=X,i="",t=this.body,t.isEmpty()?t="":(this.returns&&(t.makeReturn(r=e.scope.freeVariable("results")),i=""+this.tab+r+" = [];\n"),this.guard&&(t.expressions.length>1?t.expressions.unshift(new b((new H(this.guard)).invert(),new L("continue"))):this.guard&&(t=u.wrap([new b(this.guard,t)]))),t="\n"+t.compile(e,k)+"\n"+this.tab),n=i+this.tab+("while ("+this.condition.compile(e,C)+") {"+t+"}"),this.returns&&(n+="\n"+this.tab+"return "+r+";"),n},t}(o),t.Op=D=function(e){function r(e,n,r,i){if(e==="in")return new w(n,r);if(e==="do")return this.generateDo(n);if(e==="new"){if(n instanceof a&&!n["do"]&&!n.isNew)return n.newInstance();if(n instanceof c&&n.bound||n["do"])n=new H(n)}return this.operator=t[e]||e,this.first=n,this.second=r,this.flip=!!i,this}var t,n;return dt(r,e),t={"==":"===","!=":"!==",of:"in"},n={"!==":"===","===":"!=="},r.prototype.children=["first","second"],r.prototype.isSimpleNumber=M,r.prototype.isUnary=function(){return!this.second},r.prototype.isComplex=function(){var e;return!this.isUnary()||(e=this.operator)!=="+"&&e!=="-"||this.first.isComplex()},r.prototype.isChainable=function(){var e;return(e=this.operator)==="<"||e===">"||e===">="||e==="<="||e==="==="||e==="!=="},r.prototype.invert=function(){var e,t,i,s,o;if(this.isChainable()&&this.first.isChainable()){e=!0,t=this;while(t&&t.operator)e&&(e=t.operator in n),t=t.first;if(!e)return(new H(this)).invert();t=this;while(t&&t.operator)t.invert=!t.invert,t.operator=n[t.operator],t=t.first;return this}return(s=n[this.operator])?(this.operator=s,this.first.unwrap()instanceof r&&this.first.invert(),this):this.second?(new H(this)).invert():this.operator==="!"&&(i=this.first.unwrap())instanceof r&&((o=i.operator)==="!"||o==="in"||o==="instanceof")?i:new r("!",this)},r.prototype.unfoldSoak=function(e){var t;return((t=this.operator)==="++"||t==="--"||t==="delete")&&ft(e,this,"first")},r.prototype.generateDo=function(e){var t,n,r,i,o,u,f,l;i=[],n=e instanceof s&&(o=e.value.unwrap())instanceof c?o:e,l=n.params||[];for(u=0,f=l.length;u<f;u++)r=l[u],r.value?(i.push(r.value),delete r.value):i.push(r);return t=new a(e,i),t["do"]=!0,t},r.prototype.compileNode=function(e){var t,n,r,i;n=this.isChainable()&&this.first.isChainable(),n||(this.first.front=this.front);if(this.operator==="delete"&&e.scope.check(this.first.unwrapAll().value))throw SyntaxError("delete operand may not be argument or var");if(((r=this.operator)==="--"||r==="++")&&(i=this.first.unwrapAll().value,vt.call(q,i)>=0))throw SyntaxError("prefix increment/decrement may not have eval or arguments operand");return this.isUnary()?this.compileUnary(e):n?this.compileChain(e):this.operator==="?"?this.compileExistence(e):(t=this.first.compile(e,N)+" "+this.operator+" "+this.second.compile(e,N),e.level<=N?t:"("+t+")")},r.prototype.compileChain=function(e){var t,n,r,i;return i=this.first.second.cache(e),this.first.second=i[0],r=i[1],n=this.first.compile(e,N),t=""+n+" "+(this.invert?"&&":"||")+" "+r.compile(e)+" "+this.operator+" "+this.second.compile(e,N),"("+t+")"},r.prototype.compileExistence=function(e){var t,n;return this.first.isComplex()?(n=new L(e.scope.freeVariable("ref")),t=new H(new s(n,this.first))):(t=this.first,n=t),(new b(new p(t),n,{type:"if"})).addElse(this.second).compile(e)},r.prototype.compileUnary=function(e){var t,n,i;if(e.level>=S)return(new H(this)).compile(e);n=[t=this.operator],i=t==="+"||t==="-",(t==="new"||t==="typeof"||t==="delete"||i&&this.first instanceof r&&this.first.operator===t)&&n.push(" ");if(i&&this.first instanceof r||t==="new"&&this.first.isStatement(e))this.first=new H(this.first);return n.push(this.first.compile(e,N)),this.flip&&n.reverse(),n.join("")},r.prototype.toString=function(e){return r.__super__.toString.call(this,e,this.constructor.name+" "+this.operator)},r}(o),t.In=w=function(e){function t(e,t){this.object=e,this.array=t}return dt(t,e),t.prototype.children=["object","array"],t.prototype.invert=O,t.prototype.compileNode=function(e){var t,n,r,i,s;if(this.array instanceof Q&&this.array.isArray()){s=this.array.base.objects;for(r=0,i=s.length;r<i;r++){n=s[r];if(n instanceof z){t=!0;break}continue}if(!t)return this.compileOrTest(e)}return this.compileLoopTest(e)},t.prototype.compileOrTest=function(e){var t,n,r,i,s,o,u,a,f;return this.array.base.objects.length===0?""+!!this.negated:(a=this.object.cache(e,N),o=a[0],s=a[1],f=this.negated?[" !== "," && "]:[" === "," || "],t=f[0],n=f[1],u=function(){var n,u,a,f;a=this.array.base.objects,f=[];for(r=n=0,u=a.length;n<u;r=++n)i=a[r],f.push((r?s:o)+t+i.compile(e,S));return f}.call(this),u=u.join(n),e.level<N?u:"("+u+")")},t.prototype.compileLoopTest=function(e){var t,n,r,i;return i=this.object.cache(e,T),r=i[0],n=i[1],t=lt("indexOf")+(".call("+this.array.compile(e,T)+", "+n+") ")+(this.negated?"< 0":">= 0"),r===n?t:(t=r+", "+t,e.level<T?t:"("+t+")")},t.prototype.toString=function(e){return t.__super__.toString.call(this,e,this.constructor.name+(this.negated?"!":""))},t}(o),t.Try=J=function(e){function t(e,t,n,r){this.attempt=e,this.error=t,this.recovery=n,this.ensure=r}return dt(t,e),t.prototype.children=["attempt","recovery","ensure"],t.prototype.isStatement=Y,t.prototype.jumps=function(e){var t;return this.attempt.jumps(e)||((t=this.recovery)!=null?t.jumps(e):void 0)},t.prototype.makeReturn=function(e){return this.attempt&&(this.attempt=this.attempt.makeReturn(e)),this.recovery&&(this.recovery=this.recovery.makeReturn(e)),this},t.prototype.compileNode=function(e){var t,n,r,i;return e.indent+=X,r=this.error?" ("+this.error.compile(e)+") ":" ",i=this.attempt.compile(e,k),t=function(){var t;if(this.recovery){if(t=this.error.value,vt.call(q,t)>=0)throw SyntaxError('catch variable may not be "'+this.error.value+'"');return e.scope.check(this.error.value)||e.scope.add(this.error.value,"param")," catch"+r+"{\n"+this.recovery.compile(e,k)+"\n"+this.tab+"}"}if(!this.ensure&&!this.recovery)return" catch (_error) {}"}.call(this),n=this.ensure?" finally {\n"+this.ensure.compile(e,k)+"\n"+this.tab+"}":"",""+this.tab+"try {\n"+i+"\n"+this.tab+"}"+(t||"")+n},t}(o),t.Throw=$=function(e){function t(e){this.expression=e}return dt(t,e),t.prototype.children=["expression"],t.prototype.isStatement=Y,t.prototype.jumps=M,t.prototype.makeReturn=V,t.prototype.compileNode=function(e){return this.tab+("throw "+this.expression.compile(e)+";")},t}(o),t.Existence=p=function(e){function t(e){this.expression=e}return dt(t,e),t.prototype.children=["expression"],t.prototype.invert=O,t.prototype.compileNode=function(e){var t,n,r,i;return this.expression.front=this.front,r=this.expression.compile(e,N),m.test(r)&&!e.scope.check(r)?(i=this.negated?["===","||"]:["!==","&&"],t=i[0],n=i[1],r="typeof "+r+" "+t+' "undefined" '+n+" "+r+" "+t+" null"):r=""+r+" "+(this.negated?"==":"!=")+" null",e.level<=x?r:"("+r+")"},t}(o),t.Parens=H=function(e){function t(e){this.body=e}return dt(t,e),t.prototype.children=["body"],t.prototype.unwrap=function(){return this.body},t.prototype.isComplex=function(){return this.body.isComplex()},t.prototype.compileNode=function(e){var t,n,r;return r=this.body.unwrap(),r instanceof Q&&r.isAtomic()?(r.front=this.front,r.compile(e)):(n=r.compile(e,C),t=e.level<N&&(r instanceof D||r instanceof a||r instanceof v&&r.returns),t?n:"("+n+")")},t}(o),t.For=v=function(e){function t(e,t){var n;this.source=t.source,this.guard=t.guard,this.step=t.step,this.name=t.name,this.index=t.index,this.body=u.wrap([e]),this.own=!!t.own,this.object=!!t.object,this.object&&(n=[this.index,this.name],this.name=n[0],this.index=n[1]);if(this.index instanceof Q)throw SyntaxError("index cannot be a pattern matching expression");this.range=this.source instanceof Q&&this.source.base instanceof j&&!this.source.properties.length,this.pattern=this.name instanceof Q;if(this.range&&this.index)throw SyntaxError("indexes do not apply to range loops");if(this.range&&this.pattern)throw SyntaxError("cannot pattern match over range loops");this.returns=!1}return dt(t,e),t.prototype.children=["body","source","guard","step"],t.prototype.compileNode=function(e){var t,n,r,i,o,a,f,l,c,h,p,d,v,g,y,w,E,S,x,C,A,O,M,_,D;return t=u.wrap([this.body]),p=(D=it(t.expressions))!=null?D.jumps():void 0,p&&p instanceof F&&(this.returns=!1),C=this.range?this.source.base:this.source,x=e.scope,v=this.name&&this.name.compile(e,T),f=this.index&&this.index.compile(e,T),v&&!this.pattern&&x.find(v),f&&x.find(f),this.returns&&(S=x.freeVariable("results")),l=this.object&&f||x.freeVariable("i"),c=this.range&&v||f||l,h=c!==l?""+c+" = ":"",this.step&&!this.range&&(O=x.freeVariable("step")),this.pattern&&(v=l),_="",o="",n="",a=this.tab+X,this.range?r=C.compile(st(e,{index:l,name:v,step:this.step})):(M=this.source.compile(e,T),(v||this.own)&&!m.test(M)&&(n=""+this.tab+(y=x.freeVariable("ref"))+" = "+M+";\n",M=y),v&&!this.pattern&&(g=""+v+" = "+M+"["+c+"]"),this.object||(d=x.freeVariable("len"),i=""+h+l+" = 0, "+d+" = "+M+".length",this.step&&(i+=", "+O+" = "+this.step.compile(e,N)),A=""+h+(this.step?""+l+" += "+O:c!==l?"++"+l:""+l+"++"),r=""+i+"; "+l+" < "+d+"; "+A)),this.returns&&(w=""+this.tab+S+" = [];\n",E="\n"+this.tab+"return "+S+";",t.makeReturn(S)),this.guard&&(t.expressions.length>1?t.expressions.unshift(new b((new H(this.guard)).invert(),new L("continue"))):this.guard&&(t=u.wrap([new b(this.guard,t)]))),this.pattern&&t.expressions.unshift(new s(this.name,new L(""+M+"["+c+"]"))),n+=this.pluckDirectCall(e,t),g&&(_="\n"+a+g+";"),this.object&&(r=""+c+" in "+M,this.own&&(o="\n"+a+"if (!"+lt("hasProp")+".call("+M+", "+c+")) continue;")),t=t.compile(st(e,{indent:a}),k),t&&(t="\n"+t+"\n"),""+n+(w||"")+this.tab+"for ("+r+") {"+o+_+t+this.tab+"}"+(E||"")},t.prototype.pluckDirectCall=function(e,t){var n,r,i,o,u,f,l,h,p,d,v,m,g,y,b;r="",d=t.expressions;for(u=h=0,p=d.length;h<p;u=++h){i=d[u],i=i.unwrapAll();if(!(i instanceof a))continue;l=i.variable.unwrapAll();if(!(l instanceof c||l instanceof Q&&((v=l.base)!=null?v.unwrapAll():void 0)instanceof c&&l.properties.length===1&&((m=(g=l.properties[0].name)!=null?g.value:void 0)==="call"||m==="apply")))continue;o=((y=l.base)!=null?y.unwrapAll():void 0)||l,f=new L(e.scope.freeVariable("fn")),n=new Q(f),l.base&&(b=[n,l],l.base=b[0],n=b[1]),t.expressions[u]=new a(n,i.args),r+=this.tab+(new s(f,o)).compile(e,k)+";\n"}return r},t}(G),t.Switch=W=function(e){function t(e,t,n){this.subject=e,this.cases=t,this.otherwise=n}return dt(t,e),t.prototype.children=["subject","cases","otherwise"],t.prototype.isStatement=Y,t.prototype.jumps=function(e){var t,n,r,i,s,o,u;e==null&&(e={block:!0}),s=this.cases;for(r=0,i=s.length;r<i;r++){o=s[r],n=o[0],t=o[1];if(t.jumps(e))return t}return(u=this.otherwise)!=null?u.jumps(e):void 0},t.prototype.makeReturn=function(e){var t,n,r,i,s;i=this.cases;for(n=0,r=i.length;n<r;n++)t=i[n],t[1].makeReturn(e);return e&&(this.otherwise||(this.otherwise=new u([new L("void 0")]))),(s=this.otherwise)!=null&&s.makeReturn(e),this},t.prototype.compileNode=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;a=e.indent+X,f=e.indent=a+X,r=this.tab+("switch ("+(((d=this.subject)!=null?d.compile(e,C):void 0)||!1)+") {\n"),v=this.cases;for(u=l=0,h=v.length;l<h;u=++l){m=v[u],s=m[0],t=m[1],g=rt([s]);for(c=0,p=g.length;c<p;c++)i=g[c],this.subject||(i=i.invert()),r+=a+("case "+i.compile(e,C)+":\n");if(n=t.compile(e,k))r+=n+"\n";if(u===this.cases.length-1&&!this.otherwise)break;o=this.lastNonComment(t.expressions);if(o instanceof F||o instanceof L&&o.jumps()&&o.value!=="debugger")continue;r+=f+"break;\n"}return this.otherwise&&this.otherwise.expressions.length&&(r+=a+("default:\n"+this.otherwise.compile(e,k)+"\n")),r+this.tab+"}"},t}(o),t.If=b=function(e){function t(e,t,n){this.body=t,n==null&&(n={}),this.condition=n.type==="unless"?e.invert():e,this.elseBody=null,this.isChain=!1,this.soak=n.soak}return dt(t,e),t.prototype.children=["condition","body","elseBody"],t.prototype.bodyNode=function(){var e;return(e=this.body)!=null?e.unwrap():void 0},t.prototype.elseBodyNode=function(){var e;return(e=this.elseBody)!=null?e.unwrap():void 0},t.prototype.addElse=function(e){return this.isChain?this.elseBodyNode().addElse(e):(this.isChain=e instanceof t,this.elseBody=this.ensureBlock(e)),this},t.prototype.isStatement=function(e){var t;return(e!=null?e.level:void 0)===k||this.bodyNode().isStatement(e)||((t=this.elseBodyNode())!=null?t.isStatement(e):void 0)},t.prototype.jumps=function(e){var t;return this.body.jumps(e)||((t=this.elseBody)!=null?t.jumps(e):void 0)},t.prototype.compileNode=function(e){return this.isStatement(e)?this.compileStatement(e):this.compileExpression(e)},t.prototype.makeReturn=function(e){return e&&(this.elseBody||(this.elseBody=new u([new L("void 0")]))),this.body&&(this.body=new u([this.body.makeReturn(e)])),this.elseBody&&(this.elseBody=new u([this.elseBody.makeReturn(e)])),this},t.prototype.ensureBlock=function(e){return e instanceof u?e:new u([e])},t.prototype.compileStatement=function(e){var n,r,i,s,o;return r=et(e,"chainChild"),s=et(e,"isExistentialEquals"),s?(new t(this.condition.invert(),this.elseBodyNode(),{type:"if"})).compile(e):(i=this.condition.compile(e,C),e.indent+=X,n=this.ensureBlock(this.body),o="if ("+i+") {\n"+n.compile(e)+"\n"+this.tab+"}",r||(o=this.tab+o),this.elseBody?o+" else "+(this.isChain?(e.indent=this.tab,e.chainChild=!0,this.elseBody.unwrap().compile(e,k)):"{\n"+this.elseBody.compile(e,k)+"\n"+this.tab+"}"):o)},t.prototype.compileExpression=function(e){var t,n,r,i;return i=this.condition.compile(e,x),n=this.bodyNode().compile(e,T),t=this.elseBodyNode()?this.elseBodyNode().compile(e,T):"void 0",r=""+i+" ? "+n+" : "+t,e.level>=x?"("+r+")":r},t.prototype.unfoldSoak=function(){return this.soak&&this},t}(o),l={wrap:function(e,t,n){var i,s,o,f,l;if(e.jumps())return e;o=new c([],u.wrap([e])),i=[];if((f=e.contains(this.literalArgs))||e.contains(this.literalThis))l=new L(f?"apply":"call"),i=[new L("this")],f&&i.push(new L("arguments")),o=new Q(o,[new r(l)]);return o.noReturn=n,s=new a(o,i),t?u.wrap([s]):s},literalArgs:function(e){return e instanceof L&&e.value==="arguments"&&!e.asKey},literalThis:function(e){return e instanceof L&&e.value==="this"&&!e.asKey||e instanceof c&&e.bound||e instanceof a&&e.isSuper}},ft=function(e,t,n){var r;if(!(r=t[n].unfoldSoak(e)))return;return t[n]=r.body,r.body=new Q(t),r},K={"extends":function(){return"function(child, parent) { for (var key in parent) { if ("+lt("hasProp")+".call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; }"},bind:function(){return"function(fn, me){ return function(){ return fn.apply(me, arguments); }; }"},indexOf:function(){return"[].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; }"},hasProp:function(){return"{}.hasOwnProperty"},slice:function(){return"[].slice"}},k=1,C=2,T=3,x=4,N=5,S=6,X="  ",g="[$A-Za-z_\\x7f-\\uffff][$\\w\\x7f-\\uffff]*",m=RegExp("^"+g+"$"),I=/^[+-]?\d+$/,A=RegExp("^(?:("+g+")\\.prototype(?:\\.("+g+")|\\[(\"(?:[^\\\\\"\\r\\n]|\\\\.)*\"|'(?:[^\\\\'\\r\\n]|\\\\.)*')\\]|\\[(0x[\\da-fA-F]+|\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\]))|("+g+")$"),y=/^['"]/,lt=function(e){var t;return t="__"+e,R.root.assign(t,K[e]()),t},ot=function(e,t){return e=e.replace(/\n/g,"$&"+t),e.replace(/\s+$/,"")}});